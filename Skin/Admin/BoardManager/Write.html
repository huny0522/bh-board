<?php if(_BH_ !== true) exit;
use \BH_Common as CM;
use \BH_Application as App;

/**
 * @var $Model \BoardManagerModel
 */
?>

<h2>게시판관리</h2>

<form name="BoardManagerWriteForm" id="BoardManagerWriteForm" method="post" action="<?a. App::$Action ?><?fq. '' ?>">
	<input type="hidden" name="bid" value="<?mv('bid') ?>">
	<input type="hidden" name="select_menu" value="" id="select_menu">
	<table class="write">
		<tr>
			<th><i class="requiredBullet" title="필수항목">*</i> <?mt('subject')?></th>
			<td colspan="3">
				<?minp('subject') ?>
				<ul class="guide">
					<li>256자 이하로 입력하여주세요.</li>
				</ul>
			</td>
		</tr>
		<?php if(App::$Action == 'Write'){?>
			<tr>
				<th><i class="requiredBullet" title="필수항목">*</i> <?mt('bid')?></th>
				<td colspan="3">
					<?minp('bid') ?>
					<ul class="guide">
						<li>1자 이상, 20자 이하로 입력하여주세요.</li>
						<li>영문과 숫자만 입력하여 주세요.</li>
					</ul>
				</td>
			</tr>
		<?php }else{?>
			<tr>
				<th><?mt('bid')?></th>
				<td colspan="3"><?mv('bid') ?></td>
			</tr>
		<?php }?>
		<?php if(App::$Data['menuAuth']){?>
			<tr>
				<th>연결메뉴</th>
				<td colspan="3" class="menuSelectArea">
					<?php
					if(isset(App::$Data['selectedMenu']) && sizeof(App::$Data['selectedMenu'])){
						foreach(App::$Data['selectedMenu'] as $selectedMenu){ ?>
							<div class="menuSelect">
								<select name="selectmenu[]">
									<option value="">선택</option>
									<?php
									foreach(App::$Data['menu'] as $menu){
										$length = min(strlen($selectedMenu['category']), strlen($menu['category']));
										$selected = (strlen($selectedMenu['category']) && substr($selectedMenu['category'], 0, $length) == substr($menu['category'], 0, $length)) ? ' selected' : '';
										?>
										<option<? p.$selected ?> value="<? p.$menu['category'] ?>"><? v.$menu['title'] ?></option>
									<?php } ?>
								</select>
								<a href="#" class="menuSelectRemoveBtn sBtn">삭제</a>
							</div>
						<?php }
					}else{?>
						<div class="menuSelect">
							<select name="selectmenu[]">
								<option value="">선택</option>
								<?php foreach(App::$Data['menu'] as $menu){ ?>
									<option value="<? p.$menu['category'] ?>"><? v.$menu['title'] ?></option>
								<?php } ?>
							</select>
							<a href="#" class="menuSelectRemoveBtn sBtn">삭제</a>
						</div>
					<?php } ?>
					<a href="#" class="menuSelectAddBtn sBtn">추가</a>
				</td>
			</tr>
		<?php } ?>
		<tr>
			<th><?mt('manager')?></th>
			<td colspan="3">
				<?minp('manager') ?>
				<ul class="guide">
					<li>게시판 관리자의 아이디를 입력하여 주세요. 콤마(,)로 구분</li>
				</ul>
			</td>
		</tr>
		<tr>
			<th><?mt('skin')?></th>
			<td colspan="3">
				<?minp('skin') ?>
				<ul class="guide">
					<li>1자 이상, 20자 이하로 입력하여주세요.</li>
					<li>영문과 숫자만 입력하여 주세요.</li>
				</ul>
			</td>
		</tr>
		<tr>
			<th><?mt('reply_skin')?></th>
			<td colspan="3">
				<?minp('reply_skin') ?>
				<ul class="guide">
					<li>1자 이상, 20자 이하로 입력하여주세요.</li>
					<li>영문과 숫자만 입력하여 주세요.</li>
				</ul>
			</td>
		</tr>
		<tr>
			<th><?mt('category')?></th>
			<td colspan="3">
				<?minp('category') ?>
			</td>
		</tr>
		<tr>
			<th><?mt('article_count')?></th>
			<td>
				<?minp('article_count') ?>
				<ul class="guide">
					<li>1 이상, 100 이하의 값을 입력하여주세요.</li>
				</ul>
			</td>
			<th><?mt('reply_count')?></th>
			<td>
				<?minp('reply_count') ?>
				<ul class="guide">
					<li>1 이상, 100 이하의 값을 입력하여주세요.</li>
				</ul>
			</td>
		</tr>
		<tr>
			<th><?mt('auth_list_level')?></th>
			<td>
				<?minp('auth_list_level') ?>
			</td>
			<th><?mt('auth_write_level')?></th>
			<td>
				<?minp('auth_write_level') ?>
			</td>
		</tr>
		<tr>
			<th><?mt('auth_view_level')?></th>
			<td>
				<?minp('auth_view_level') ?>
			</td>
			<th><?mt('auth_reply_level')?></th>
			<td>
				<?minp('auth_reply_level') ?>
			</td>
		</tr>
		<tr>
			<th><?mt('auth_answer_level')?></th>
			<td>
				<?minp('auth_answer_level') ?>
			</td>
			<th><?mt('use_reply')?></th>
			<td>
				<?minp('use_reply') ?>
			</td>
		</tr>
		<tr>
			<th><?mt('list_in_view')?></th>
			<td>
				<?minp('list_in_view') ?>
			</td>
			<th><?mt('man_to_man')?></th>
			<td>
				<?minp('man_to_man') ?>
			</td>
		</tr>
		<tr>
			<th><?mt('attach_type')?></th>
			<td colspan="3">
				<?minp('attach_type') ?>
			</td>
		</tr>
		<tr>
			<th><?mt('layout')?></th>
			<td colspan="3">
				<?minp('layout') ?>
				<ul class="guide">
					<li>1자 이상, 50자 이하로 입력하여주세요.</li>
				</ul>
			</td>
		</tr>
		<tr>
			<th><?mt('new_view_day')?></th>
			<td colspan="3">
				<?minp('new_view_day') ?>
				<ul class="guide">
					<li>1 이상, 50 이하의 값을 입력하여주세요.</li>
				</ul>
			</td>
		</tr>
	</table>

	<div class="bottomBtn">
		<button type="submit" class="bBtn"><?php echo App::$Action == 'Modify' ? '수정' : '등록'; ?></button>
		<button type="reset" class="bBtn">취소</button>
		<a href="#" class="backbtn bBtn">뒤로</a>
	</div>
</form>

<script>
	$(document).on('submit', '#BoardManagerWriteForm', function(e){
		var ms = '';
		$('div.menuSelect').each(function(){
			var obj = $(this).find('select').last();
			while(obj.length && obj.val() == ''){
				obj = obj.prev();
			}
			if(obj.length && obj.val() != ''){
				ms += (ms == '' ? '' : ',') + obj.val();
			}
		});
		$('#select_menu').val(ms);

		var res = $(this).validCheck();
		if(!res){
			e.preventDefault();
			return false;
		}
	});

	<?php if(App::$Data['menuAuth']){?>

	$(document).on('change', '.menuSelect select', function(){
		removeNext(this);
		getSubMenu(this);
	});

	$(document).ready(function(){
		<?php if(isset(App::$Data['selectedMenu'])) foreach(App::$Data['selectedMenu'] as $k => $selectedMenu){ ?>
		getSubMenu($('.menuSelect').eq(<?p. $k ?>).find('select'), '<?p. $selectedMenu['category'] ?>');
		<?php } ?>
	});

	function removeNext(obj){
		if($(obj).next().next().length) removeNext($(obj).next());
		if($(obj).next().length && $(obj).next()[0].tagName == 'SELECT') $(obj).next().remove();
	}

	function getSubMenu(obj, nowCategory){
		if($(obj).val() == '') return;
		if(typeof nowCategory == 'undefined') nowCategory = '';
		JCM.get('<?a. 'GetSubMenu' ?>/' + $(obj).val(), {}, function(data){
			if(data.length){
				var html = '<select>' +
					'<option value="">선택</option>';

				for(var i=0; i < data.length; i++){
					var selected = (nowCategory != '' && data[i].category == nowCategory.substr(0, data[i].category.length)) ? ' selected' : '';
					html += '<option' + selected + ' value="' + data[i].category + '">' + data[i].title + '</option>';
				}
				html += '</select>';
				$(obj).closest('.menuSelect').find('select').last().after(html);
				if($(obj).next().val() != '') getSubMenu($(obj).next(), nowCategory);
			}
		});
	}

	$(document).on('click', 'a.menuSelectAddBtn', function(e){
		e.preventDefault();
		var html = $('.menuSelect select').eq(0).html().replace(/selected/ig, '');
		$(this).before('<div class="menuSelect"><select name="selectmenu[]">' + html + '</select><a href="#" class="menuSelectRemoveBtn sBtn">삭제</a></div>');
	});

	$(document).on('click', 'a.menuSelectRemoveBtn', function(e){
		e.preventDefault();
		if($('.menuSelect').length < 2) return;
		$(this).closest('.menuSelect').remove();
	});

	<?php } ?>
</script>
